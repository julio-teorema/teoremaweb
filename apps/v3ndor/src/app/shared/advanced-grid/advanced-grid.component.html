@if (!isMobile()) {
<!-- ═══ Desktop: Toolbar + Table ═══ -->
<div class="desktop-toolbar">
  <div class="toolbar-left">
    <p-iconfield class="toolbar-search">
      <p-inputicon styleClass="pi pi-search" />
      <input pInputText type="text" [value]="globalFilterValue()" (input)="onGlobalFilter($event)"
        placeholder="Buscar..." class="p-inputtext-sm" style="width: 100%" />
    </p-iconfield>
    <span class="toolbar-count">
      <span class="font-semibold">{{ data.length }}</span> registros
    </span>
  </div>
  <div class="toolbar-right">
    <p-select [options]="groupOptions()" [ngModel]="groupByField()" (ngModelChange)="groupByField.set($event)"
      optionLabel="label" optionValue="value" placeholder="Agrupar por" styleClass="p-select-sm"
      style="min-width: 140px" />
    <p-multiSelect [options]="columns" [(ngModel)]="selectedColumns" optionLabel="header" placeholder="Colunas"
      [maxSelectedLabels]="0" selectedItemsLabel="{0} colunas" (onChange)="onColumnToggle($event.value)"
      styleClass="p-multiselect-sm" />
    <p-button icon="pi pi-filter-slash" [outlined]="true" severity="secondary" size="small" pTooltip="Limpar filtros"
      tooltipPosition="bottom" (onClick)="clearFilters()" />
    <p-button icon="pi pi-download" [outlined]="true" severity="secondary" size="small" pTooltip="Exportar CSV"
      tooltipPosition="bottom" (onClick)="exportCSV()" />
  </div>
</div>

@if (groupByField()) {
<!-- Grouped table (manual grouping) -->
<p-table #dt [value]="groupedData()" [columns]="visibleColumns()" [loading]="loading" [scrollable]="true"
  scrollHeight="flex" [tableStyle]="{ 'min-width': '60rem' }" [exportFilename]="title || 'export'"
  styleClass="p-datatable-sm has-toolbar advanced-grid-table">

  <ng-template pTemplate="header" let-columns>
    <tr>
      @for (col of columns; track col.field) {
      <th [style]="getColumnStyle(col)">{{ col.header }}</th>
      }
    </tr>
  </ng-template>

  <ng-template pTemplate="body" let-row let-columns="columns">
    @if (isGroupHeader(row)) {
    <tr class="group-header-row" (click)="toggleGroup($any(row)._groupValue)" style="cursor: pointer;">
      <td [attr.colspan]="visibleColumns().length">
        <i class="pi"
          [ngClass]="(expandedGroups().has($any(row)._groupValue) || globalFilterValue()) ? 'pi-chevron-down' : 'pi-chevron-right'"
          style="font-size: 0.75rem; margin-right: 0.5rem;"></i>
        <span class="font-semibold">{{ getGroupLabel() }}:</span>
        <span class="ml-2">{{ $any(row)._groupValue || '(vazio)' }}</span>
        <span class="ml-2 text-surface-400" style="font-size: 0.75rem;">({{ $any(row)._groupCount }})</span>
      </td>
    </tr>
    } @else {
    <tr class="cursor-pointer" [class.urgent-row]="($any(row)).urgent === 1">
      @for (col of columns; track col.field) {
      @if (getCellHtml(row, col)) {
      <td [style]="getColumnStyle(col)" [innerHTML]="getCellHtml(row, col)"></td>
      } @else {
      <td [style]="getColumnStyle(col)" [innerHTML]="highlightText(getCellValue(row, col), col)"></td>
      }
      }
    </tr>
    }
  </ng-template>

  <ng-template pTemplate="emptymessage">
    <tr>
      <td [attr.colspan]="visibleColumns().length" style="text-align: center; padding: 3rem 1rem;">
        <div style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem;">
          <i class="pi pi-inbox" style="font-size: 2rem; color: var(--v-text-muted);"></i>
          <span style="color: var(--v-text-secondary); font-size: 0.875rem;">Nenhum registro encontrado</span>
        </div>
      </td>
    </tr>
  </ng-template>
</p-table>
} @else {
<!-- Normal table (no grouping) -->
<p-table #dt [value]="data" [columns]="visibleColumns()" [loading]="loading" [globalFilterFields]="getFilterFields()"
  [scrollable]="true" scrollHeight="flex" [virtualScroll]="data.length > 100" [virtualScrollItemSize]="36"
  [resizableColumns]="config.resizableColumns || false" [reorderableColumns]="true"
  [showGridlines]="config.showGridlines || false" [stripedRows]="config.stripedRows || false"
  [tableStyle]="{ 'min-width': '60rem' }" (onRowSelect)="rowSelect.emit($any($event).data)"
  (onRowDblClick)="rowDblClick.emit($any($event).data)" (onColReorder)="onColReorder($event)"
  [exportFilename]="title || 'export'" styleClass="p-datatable-sm has-toolbar advanced-grid-table">

  <ng-template pTemplate="header" let-columns>
    <tr>
      @for (col of columns; track col.field) {
      <th pReorderableColumn [pSortableColumn]="col.sortable !== false ? col.field : undefined"
        [style]="getColumnStyle(col)">
        <div class="th-content">
          <span>{{ col.header }}</span>
          @if (col.sortable !== false) { <p-sortIcon [field]="col.field" /> }
          @if (col.filterable !== false) {
          @switch (col.filterType) {
          @case ('numeric') { <p-columnFilter type="numeric" [field]="col.field" display="menu" /> }
          @case ('date') { <p-columnFilter type="date" [field]="col.field" display="menu" /> }
          @case ('dropdown') {
          <p-columnFilter [field]="col.field" matchMode="in" display="menu" [showMatchModes]="false"
            [showOperator]="false" [showAddButton]="false">
            <ng-template pTemplate="filter" let-value let-filterCallback="filterCallback">
              <p-multiSelect [options]="getColumnFilterOptions(col.field)" [ngModel]="value"
                (ngModelChange)="filterCallback($event)" optionLabel="label" optionValue="value" placeholder="Todos"
                [maxSelectedLabels]="1" selectedItemsLabel="{0} selecionados" styleClass="p-multiselect-sm"
                style="min-width: 200px" />
            </ng-template>
          </p-columnFilter>
          }
          @default {
          <p-columnFilter type="text" [field]="col.field" [matchMode]="'contains'" display="menu"
            [showMatchModes]="false" [showOperator]="false" [showAddButton]="false" />
          }
          }
          }
        </div>
      </th>
      }
    </tr>
  </ng-template>

  <ng-template pTemplate="body" let-row let-columns="columns">
    <tr class="cursor-pointer" [class.urgent-row]="($any(row)).urgent === 1" (click)="rowSelect.emit(row)">
      @for (col of columns; track col.field) {
      @if (getCellHtml(row, col)) {
      <td [style]="getColumnStyle(col)" [innerHTML]="getCellHtml(row, col)"></td>
      } @else {
      <td [style]="getColumnStyle(col)" [innerHTML]="highlightText(getCellValue(row, col), col)"></td>
      }
      }
    </tr>
  </ng-template>

  <ng-template pTemplate="emptymessage">
    <tr>
      <td [attr.colspan]="visibleColumns().length" style="text-align: center; padding: 3rem 1rem;">
        <div style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem;">
          <i class="pi pi-inbox" style="font-size: 2rem; color: var(--v-text-muted);"></i>
          <span style="color: var(--v-text-secondary); font-size: 0.875rem;">Nenhum registro encontrado</span>
        </div>
      </td>
    </tr>
  </ng-template>
</p-table>
}
} @else {
<!-- ═══ Mobile: Card list ═══ -->
<div class="mobile-grid">
  <div class="mobile-toolbar">
    <p-iconfield class="flex-1">
      <p-inputicon styleClass="pi pi-search" />
      <input pInputText type="text" [value]="globalFilterValue()" (input)="onCardFilter($any($event.target).value)"
        placeholder="Buscar..." class="p-inputtext-sm w-full" />
    </p-iconfield>
    <span class="text-xs text-surface-500 whitespace-nowrap">
      {{ filteredData().length }} registros
    </span>
  </div>

  <div class="mobile-cards">
    @for (row of filteredData(); track $index) {
    <div class="mobile-card" [class.urgent-card]="($any(row)).urgent === 1" tabindex="0" role="button"
      (click)="rowSelect.emit(row)" (keyup.enter)="rowSelect.emit(row)">
      @for (col of visibleColumns(); track col.field) {
      <div class="mobile-card-field">
        <span class="mobile-card-label">{{ col.header }}</span>
        @if (getCellHtml(row, col)) {
        <span class="mobile-card-value" [innerHTML]="getCellHtml(row, col)"></span>
        } @else {
        <span class="mobile-card-value">{{ getCellValue(row, col) }}</span>
        }
      </div>
      }
    </div>
    } @empty {
    <div class="mobile-empty">
      <i class="pi pi-inbox text-4xl text-surface-400 block mb-3"></i>
      <p class="text-surface-500 m-0">Nenhum registro encontrado</p>
    </div>
    }
  </div>
</div>
}